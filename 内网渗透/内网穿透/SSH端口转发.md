# SSH端口转发

## 8.1简介

SSH端口转发（隧道）功能强大、用途广泛，仅仅一行代码便可以将两台主机联系起来，对特定的访问请求进行代理



## 8.2本地端口转发

本地端口转发是将应用【application client】对于本地主机C指定端口X的访问请求转发给主机B，交由主机B对另一指定主机A的指定端口Z发起访问

```
ssh -L 主机C端口X:主机A:主机A端口Z username@hostname
# 简单理解为：将对C:X的访问转变成对A:Z的访问
```

当主机C在其某端口提供某服务【application server】，主机C需要使用该服务却无法直接访问主机A或该端口时，如果发现有SSH：C→的连接，且主机B能够直接访问主机A的该端口，本地端口转发就派上用场



场景如下:

![image-20210804192843217](C:\Users\涛乖\AppData\Roaming\Typora\typora-user-images\image-20210804192843217.png)

由于位于外网的主机C不能访问主机A，只能通过暴露在公网的主机Bssh隧道转发来连接内网中的主机A



在主机C上输入如下命令连接主机B的ssh服务

```
ssh -L 12345:192.168.233.242(主机A的ip):22  haoyun@192.168.137.1(主机B的ip)
```



然后我们去使用ssh连接本地的12345端口就可以访问目标机器的ssh服务

```
ssh -p 12345 haoyun(主机A的用户)@127.0.0.1
```



上面两个命令实际上就是直接连接主机C 的ssh服务

若主机C能和主机A连同的，和下面的命令一样

```
ssh  haoyun@192.168.233.242
```





## 8.3远程端口转发

当主机C在其某端口提供某服务，主机B需要使用该服务却无法直接访问主机C或该端口时，如果发现有SSH：A→B的连接，且主机A能够直接访问主机C的该端口，远程端口转发就派上用场

需注意，此时访问请求在主机B一侧发生，而SSH连接的方向却没有变化，仍是由A到B的。因此「本地与远程端口转发互为镜像」的说法并不完全准确；严格意义上的镜像，SSH连接也要变为由B到A，那时则应该是在B上采用本地端口转发。可以看出，采取哪种端口转发主要取决于SSH连接建立的方向。

场景如下:

![image-20210804201206425](C:\Users\涛乖\AppData\Roaming\Typora\typora-user-images\image-20210804201206425.png)



与本地端口转发的流动方向相反，远程端口转发是将对于远程主机C指定端口Y的访问请求转发给主机B，交由主机B对另一指定主机A的指定端口Z发起访问。命令如下：

```bash
ssh -R 主机c端口Y:主机A:主机A端口Z username@hostname
# 简单理解为：将对C:Y的访问转变成对A:Z的访问
```



在主机B上执行以下命令:

```
ssh  -R   12345(主机C的任意端口):192.168.233.242(主机A的ip):22  haoyun@192.168.137.183(主机C的ip地址)
```

![image-20210804203456628](C:\Users\涛乖\AppData\Roaming\Typora\typora-user-images\image-20210804203456628.png)



然后在主机C上执行以下命令连接主机A的ssh服务

```
ssh -p 12345(本机监听端口)  haoyun(主机A用户名)@127.0.0.1
```





## 8.3总结

![image-20210804212532832](D:\Application program\文本编辑器\Typora\内网渗透\内网穿透\SSH端口转发.assets\image-20210804212532832.png)

从图上可以看出，

1.对于本地端口转发,localhost指的是我们使用ssh连接的目标主机

   ssh请求是位于外网中的主机连接内网中暴露在公网上的主机



2.对于远程端口转发,localhost指的是我们执行ssh连接的主机

   ssh请求是位于内网并暴露在外网的主机去连接位于外网中的主机



